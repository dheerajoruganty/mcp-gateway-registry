{{/*
Shared secret for auth-server and registry.
Generates a random secretKey if not provided via global.secretKey.
Both services reference this single secret for SECRET_KEY.
*/}}
{{- $secretName := .Values.global.sharedSecretName | default "shared-secret" }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- $secretKey := "" }}
{{- if .Values.global.secretKey }}
  {{- $secretKey = .Values.global.secretKey }}
{{- else if $existingSecret }}
  {{- $secretKey = index $existingSecret.data "SECRET_KEY" | b64dec }}
{{- else }}
  {{- $secretKey = randAlphaNum 64 }}
{{- end }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  namespace: {{ .Release.Namespace | quote }}
  labels:
    {{- include "mcp-gateway-registry-stack.labels" . | nindent 4 }}
type: Opaque
data:
  SECRET_KEY: {{ $secretKey | b64enc | quote }}
