#
# Amazon DocumentDB Elastic Cluster Infrastructure for MCP Gateway Registry
#
# This configuration creates a DocumentDB Elastic Cluster with VPC access
# for the MCP Gateway Registry backend storage and vector search.
#

#
# DocumentDB Elastic Cluster
#
resource "aws_docdbelastic_cluster" "registry" {
  name = "${var.name}-registry"

  # Authentication
  admin_user_name     = var.documentdb_admin_username
  admin_user_password = var.documentdb_admin_password
  auth_type           = "PLAIN_TEXT"

  # Capacity
  shard_capacity = var.documentdb_shard_capacity
  shard_count    = var.documentdb_shard_count

  # Network configuration
  vpc_security_group_ids = [aws_security_group.documentdb.id]
  subnet_ids             = module.vpc.private_subnets

  # Backup configuration
  backup_retention_period      = 7
  preferred_backup_window      = "02:00-04:00"
  preferred_maintenance_window = "sun:04:00-sun:05:00"

  # Encryption
  kms_key_id = aws_kms_key.documentdb.arn

  # Tags temporarily removed due to IAM permission issue
  # Add docdb-elastic:TagResource permission to IAM role to enable tagging
  # tags = merge(
  #   local.common_tags,
  #   {
  #     Name        = "${var.name}-registry-docdb"
  #     Component   = "documentdb"
  #     Environment = "production"
  #     Service     = "mcp-gateway-registry"
  #   }
  # )
}

#
# Security Group for DocumentDB
#
resource "aws_security_group" "documentdb" {
  name        = "${var.name}-v2-documentdb-sg"
  description = "Security group for DocumentDB Elastic Cluster"
  vpc_id      = module.vpc.vpc_id

  tags = merge(
    local.common_tags,
    {
      Name      = "${var.name}-v2-documentdb-sg"
      Component = "documentdb"
    }
  )
}

# Ingress from Registry service
resource "aws_vpc_security_group_ingress_rule" "documentdb_from_registry" {
  security_group_id = aws_security_group.documentdb.id

  referenced_security_group_id = module.mcp_gateway.ecs_security_group_ids.registry
  from_port                    = 27017
  to_port                      = 27017
  ip_protocol                  = "tcp"
  description                  = "Allow MongoDB protocol from Registry ECS service to DocumentDB"

  tags = merge(
    local.common_tags,
    {
      Name = "documentdb-from-registry"
    }
  )
}

# Ingress from Auth service (if auth service needs DocumentDB access)
resource "aws_vpc_security_group_ingress_rule" "documentdb_from_auth" {
  security_group_id = aws_security_group.documentdb.id

  referenced_security_group_id = module.mcp_gateway.ecs_security_group_ids.auth
  from_port                    = 27017
  to_port                      = 27017
  ip_protocol                  = "tcp"
  description                  = "Allow MongoDB protocol from Auth ECS service to DocumentDB"

  tags = merge(
    local.common_tags,
    {
      Name = "documentdb-from-auth"
    }
  )
}

# Egress (DocumentDB doesn't need outbound, but best practice to allow)
resource "aws_vpc_security_group_egress_rule" "documentdb_egress" {
  security_group_id = aws_security_group.documentdb.id

  cidr_ipv4   = "0.0.0.0/0"
  ip_protocol = "-1"
  description = "Allow all outbound traffic"

  tags = merge(
    local.common_tags,
    {
      Name = "documentdb-egress-all"
    }
  )
}

#
# Security Group Rules for Registry and Auth services to reach DocumentDB
#

# Registry -> DocumentDB
resource "aws_vpc_security_group_egress_rule" "registry_to_documentdb" {
  security_group_id = module.mcp_gateway.ecs_security_group_ids.registry

  referenced_security_group_id = aws_security_group.documentdb.id
  from_port                    = 27017
  to_port                      = 27017
  ip_protocol                  = "tcp"
  description                  = "Allow Registry service to connect to DocumentDB"

  tags = merge(
    local.common_tags,
    {
      Name = "registry-to-documentdb"
    }
  )
}

# Auth -> DocumentDB
resource "aws_vpc_security_group_egress_rule" "auth_to_documentdb" {
  security_group_id = module.mcp_gateway.ecs_security_group_ids.auth

  referenced_security_group_id = aws_security_group.documentdb.id
  from_port                    = 27017
  to_port                      = 27017
  ip_protocol                  = "tcp"
  description                  = "Allow Auth service to connect to DocumentDB"

  tags = merge(
    local.common_tags,
    {
      Name = "auth-to-documentdb"
    }
  )
}

#
# KMS Key for DocumentDB Encryption
#
resource "aws_kms_key" "documentdb" {
  description             = "KMS key for DocumentDB Elastic Cluster encryption"
  deletion_window_in_days = 7
  enable_key_rotation     = true

  tags = merge(
    local.common_tags,
    {
      Name      = "${var.name}-documentdb-key"
      Component = "documentdb"
    }
  )
}

resource "aws_kms_alias" "documentdb" {
  name          = "alias/${var.name}-documentdb"
  target_key_id = aws_kms_key.documentdb.key_id
}

#
# Secrets Manager Secret for DocumentDB Credentials
#
resource "aws_secretsmanager_secret" "documentdb_credentials" {
  name                    = "${var.name}/documentdb/credentials"
  description             = "DocumentDB Elastic Cluster admin credentials"
  recovery_window_in_days = 7

  tags = merge(
    local.common_tags,
    {
      Component = "documentdb"
    }
  )
}

resource "aws_secretsmanager_secret_version" "documentdb_credentials" {
  secret_id = aws_secretsmanager_secret.documentdb_credentials.id
  secret_string = jsonencode({
    username = var.documentdb_admin_username
    password = var.documentdb_admin_password
    engine   = "docdb"
  })
}

#
# SSM Parameters for Application Configuration
#
resource "aws_ssm_parameter" "documentdb_endpoint" {
  name        = "/${var.name}/documentdb/endpoint"
  description = "DocumentDB Elastic Cluster endpoint"
  type        = "String"
  value       = aws_docdbelastic_cluster.registry.endpoint

  tags = merge(
    local.common_tags,
    {
      Component = "documentdb"
    }
  )
}

resource "aws_ssm_parameter" "documentdb_connection_string" {
  name        = "/${var.name}/documentdb/connection_string"
  description = "DocumentDB Elastic Cluster connection string"
  type        = "SecureString"
  value = format(
    "mongodb://%s:%s@%s:27017/?tls=true&tlsCAFile=global-bundle.pem&replicaSet=rs0&readPreference=secondaryPreferred&retryWrites=false",
    var.documentdb_admin_username,
    var.documentdb_admin_password,
    aws_docdbelastic_cluster.registry.endpoint
  )

  tags = merge(
    local.common_tags,
    {
      Component = "documentdb"
    }
  )
}
